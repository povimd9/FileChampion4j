<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileAclHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">filechampion4j</a> &gt; <a href="index.source.html" class="el_package">dev.filechampion.filechampion4j</a> &gt; <span class="el_source">FileAclHelper.java</span></div><h1>FileAclHelper.java</h1><pre class="source lang-java linenums">package dev.filechampion.filechampion4j;

import java.io.IOException;
import java.nio.file.AccessDeniedException;
import java.nio.file.FileSystemException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.attribute.*;
import java.util.*;
import java.util.logging.Level;
import java.util.logging.LogManager;
import java.util.logging.Logger;

/**
 * This class is used to change the owner and permissions of a file.
 * Set Owner uses java.nio.file.Files.setOwner for cross-platform support.
 * Set Permissions attempts to identify the Operating System, using java.nio.file.attribute.AclFileAttributeView for Windows, 
 * and java.nio.file.attribute.PosixFileAttributeView for any other.
 */

public class FileAclHelper {
    private Path targetFilePath;
    private String newPermissions;
    private String newOwnerUsername;
<span class="fc" id="L25">    private StringBuilder errMsg = new StringBuilder();</span>

    static {
        try {
<span class="fc" id="L29">            LogManager.getLogManager().readConfiguration(</span>
<span class="fc" id="L30">                FileValidator.class.getResourceAsStream(&quot;/logging.properties&quot;));</span>
<span class="nc" id="L31">        } catch (IOException e) {</span>
<span class="nc" id="L32">            throw new IllegalArgumentException(&quot;Could not load default logging configuration: &quot;, e);</span>
<span class="fc" id="L33">        }</span>
    }
<span class="fc" id="L35">    private static final Logger LOGGER = Logger.getLogger(FileAclHelper.class.getName());</span>
    private void logSevere(String message) {
<span class="pc bpc" id="L37" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.SEVERE)) {</span>
<span class="fc" id="L38">            LOGGER.severe(message);</span>
        }
<span class="fc" id="L40">    }</span>
    private void logFine(String message) {
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">        if (LOGGER.isLoggable(Level.FINE )) {</span>
<span class="nc" id="L43">            LOGGER.fine(message);</span>
        }
<span class="fc" id="L45">    }</span>

    /**
     * Class constructor
     * @param targetFilePath (Path) the path of the file to change
     * @param newOwnerUsername (String) the new owner of the file
     * @param newPermissions (String the new permissions of the file (e.g. &quot;rwx&quot;)
     */
<span class="fc" id="L53">    public FileAclHelper(Path targetFilePath, String newOwnerUsername, String newPermissions) throws IllegalArgumentException {</span>
<span class="fc" id="L54">        this.targetFilePath = targetFilePath;</span>
<span class="fc" id="L55">        this.newOwnerUsername = newOwnerUsername;</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (!newPermissions.matches(&quot;[rwx]+&quot;)) {</span>
<span class="fc" id="L57">            errMsg.replace(0, errMsg.length(), &quot;Error: Invalid permissions:&quot;).append(newPermissions);</span>
<span class="fc" id="L58">            throw new IllegalArgumentException(errMsg.toString());</span>
        }
<span class="fc" id="L60">        this.newPermissions = newPermissions;</span>
<span class="fc" id="L61">    }</span>


    /**
     * changeFileAcl is the main method of this class. It attempts to change the owner and permissions of a file.
     * @return (String) a String containing the result of the operation
    */
    public String changeFileAcl() {
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        if(!newPermissions.matches(&quot;[rwx]+&quot;)) {</span>
<span class="nc" id="L70">            errMsg.replace(0, errMsg.length(), &quot;Error: Invalid permissions:&quot;).append(newPermissions);</span>
<span class="nc" id="L71">            return errMsg.toString();</span>
        }
<span class="fc" id="L73">        UserPrincipal newOwner = getUserPrinciple(targetFilePath, newOwnerUsername);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (newOwner == null) {</span>
<span class="fc" id="L75">            errMsg.replace(0, errMsg.length(), &quot;Error: Could not get user principal for &quot;).append(newOwnerUsername);</span>
<span class="fc" id="L76">            return errMsg.toString();</span>
        }

        // Try to change the owner of the file
<span class="fc" id="L80">        String newOwnerChangeResults = setNewOwner(newOwner);</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">        if (newOwnerChangeResults.contains(&quot;Error&quot;)) {</span>
<span class="fc" id="L82">            return newOwnerChangeResults;</span>
        }

        // Try to change the permissions of the file
<span class="fc" id="L86">        String newPermissionsChangeResults = setNewPermissions(newOwner);</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if (newPermissionsChangeResults.contains(&quot;Error&quot;)) {</span>
<span class="nc" id="L88">            return newPermissionsChangeResults;</span>
        }
        
        // If we get here, both the owner and permissions were changed successfully
<span class="fc" id="L92">        String successMessage = String.format(&quot;Success: Changed owner and permissions of file %s&quot;, targetFilePath.toAbsolutePath());</span>
<span class="fc" id="L93">        logFine(successMessage);</span>
<span class="fc" id="L94">        return successMessage;</span>
    }

    // Get the user principal for the new owner
    private UserPrincipal getUserPrinciple (Path targetFilePath, String newOwnerUsername) {
        try {
<span class="fc" id="L100">            return targetFilePath.getFileSystem()</span>
<span class="fc" id="L101">            .getUserPrincipalLookupService()</span>
<span class="fc" id="L102">            .lookupPrincipalByName(newOwnerUsername);</span>
<span class="fc" id="L103">        } catch (Exception e) {</span>
<span class="fc" id="L104">            errMsg.replace(0, errMsg.length(), &quot;Error: Exception getting user principal: &quot;).append(e.getMessage());</span>
<span class="fc" id="L105">            logSevere(errMsg.toString());</span>
<span class="fc" id="L106">            return null;</span>
        }
    }

    // Change the owner of the file
    private String setNewOwner(UserPrincipal newOwner) {
        try {
            // Change the owner of the file
<span class="fc" id="L114">            Files.setOwner(targetFilePath, newOwner);</span>
<span class="fc" id="L115">            errMsg.replace(0, errMsg.length(), &quot;Success: Changed owner of file&quot;).append(targetFilePath.toAbsolutePath()).append(&quot; to &quot;).append(newOwnerUsername);</span>
<span class="fc" id="L116">            logFine(errMsg.toString());</span>
<span class="fc" id="L117">            return errMsg.toString();</span>
<span class="fc" id="L118">        } catch (AccessDeniedException e) {</span>
<span class="fc" id="L119">            errMsg.replace(0, errMsg.length(), &quot;Error: Access denied while changing file owner: &quot;).append(e.getMessage());</span>
<span class="fc" id="L120">            logSevere(errMsg.toString());</span>
<span class="fc" id="L121">            return errMsg.toString();</span>
<span class="fc" id="L122">        } catch (FileSystemException e) {</span>
<span class="fc" id="L123">            errMsg.replace(0, errMsg.length(), &quot;Error: File system error while changing file owner: &quot;).append(e.getMessage());</span>
<span class="fc" id="L124">            logSevere(errMsg.toString());</span>
<span class="fc" id="L125">            return errMsg.toString();</span>
        }
<span class="nc" id="L127">        catch (Exception e) {</span>
<span class="nc" id="L128">            errMsg.replace(0, errMsg.length(), &quot;Error: Exception while changing file owner: &quot;).append(e.getMessage());</span>
<span class="nc" id="L129">            logSevere(errMsg.toString());</span>
<span class="nc" id="L130">            return errMsg.toString();</span>
        }
    }

    // Check the OS and call the appropriate method to change the permissions
    private String setNewPermissions(UserPrincipal newOwner) {
<span class="fc" id="L136">        String os = System.getProperty(&quot;os.name&quot;);</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (os.startsWith(&quot;Windows&quot;)) {</span>
<span class="fc" id="L138">            return setNewPermissionsWindows(newOwner);</span>
        } else {
<span class="nc" id="L140">            return setNewPermissionsUnix();</span>
        }
    }

    // Change the permissions of the file using ACL on Windows OS
    private String setNewPermissionsWindows(UserPrincipal newOwner) {
        try {
            String statusMessage;
            // Change the permissions of the file using ACLs
<span class="fc" id="L149">            AclFileAttributeView aclView = Files.getFileAttributeView(targetFilePath, AclFileAttributeView.class);</span>
<span class="fc" id="L150">            AclEntryPermission readPermission = AclEntryPermission.READ_DATA;</span>
<span class="fc" id="L151">            AclEntryPermission writePermission = AclEntryPermission.WRITE_DATA;</span>
<span class="fc" id="L152">            AclEntryPermission executePermission = AclEntryPermission.EXECUTE;</span>

<span class="fc" id="L154">            AclEntryType allow = AclEntryType.ALLOW;</span>

<span class="fc" id="L156">            EnumSet&lt;AclEntryPermission&gt; actualPermissions = EnumSet.noneOf(AclEntryPermission.class);</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (newPermissions.contains(&quot;r&quot;)) {</span>
<span class="fc" id="L158">                actualPermissions.add(readPermission);</span>
            }
<span class="fc bfc" id="L160" title="All 2 branches covered.">            if (newPermissions.contains(&quot;w&quot;)) {</span>
<span class="fc" id="L161">                actualPermissions.add(writePermission);</span>
            }
<span class="fc bfc" id="L163" title="All 2 branches covered.">            if (newPermissions.contains(&quot;x&quot;)) {</span>
<span class="fc" id="L164">                actualPermissions.add(executePermission);</span>
            }

<span class="fc" id="L167">            statusMessage = String.format(&quot;Attempting to change permissions to %s&quot;, actualPermissions);</span>
<span class="fc" id="L168">            logFine(statusMessage);</span>

            // Create the new ACL entry
<span class="fc" id="L171">            AclEntry aclEntry = AclEntry.newBuilder()</span>
<span class="fc" id="L172">                    .setType(allow)</span>
<span class="fc" id="L173">                    .setPrincipal(newOwner)</span>
<span class="fc" id="L174">                    .setPermissions(actualPermissions)</span>
<span class="fc" id="L175">                    .build();</span>

            // Get the existing ACL and add the new ACL entries
<span class="fc" id="L178">            List&lt;AclEntry&gt; acl = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L179">            acl.add(aclEntry);</span>

            // Set the new ACL
<span class="fc" id="L182">            aclView.setAcl(acl);</span>
<span class="fc" id="L183">            errMsg.replace(0, errMsg.length(), &quot;Success: Changed permissions of file&quot;).append(targetFilePath.toAbsolutePath()).append(&quot; to &quot;).append(actualPermissions);</span>
<span class="fc" id="L184">            logFine(errMsg.toString());</span>
<span class="fc" id="L185">            return errMsg.toString();</span>
<span class="nc" id="L186">        } catch (Exception e) {</span>
<span class="nc" id="L187">            errMsg.replace(0, errMsg.length(), &quot;Error: Exception setting permissions on file with ACL: &quot;)</span>
<span class="nc" id="L188">                .append(targetFilePath.toAbsolutePath())</span>
<span class="nc" id="L189">                .append(&quot;, &quot;)</span>
<span class="nc" id="L190">                .append(e.getMessage());</span>
<span class="nc" id="L191">            logSevere(errMsg.toString());</span>
<span class="nc" id="L192">            return errMsg.toString();</span>
        }
    }

    // Change the permissions of the file using POSIX on Unix OS
    private String setNewPermissionsUnix() {
        String statusMessage;

        // Build the new permissions
<span class="nc" id="L201">        Set&lt;PosixFilePermission&gt; permissions = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (newPermissions.contains(&quot;r&quot;)) {</span>
<span class="nc" id="L203">            permissions.add(PosixFilePermission.OWNER_READ);</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (newPermissions.contains(&quot;w&quot;)) {</span>
<span class="nc" id="L206">            permissions.add(PosixFilePermission.OWNER_WRITE);</span>
        }
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (newPermissions.contains(&quot;x&quot;)) {</span>
<span class="nc" id="L209">            permissions.add(PosixFilePermission.OWNER_EXECUTE);</span>
        }

        // Change the permissions of the file using POSIX
        try {
<span class="nc" id="L214">            statusMessage = String.format(&quot;Attempting to change permissions to %s&quot;, permissions);</span>
<span class="nc" id="L215">            logFine(statusMessage);</span>
<span class="nc" id="L216">            Files.setPosixFilePermissions(targetFilePath.toAbsolutePath(), permissions);</span>
<span class="nc" id="L217">            errMsg.replace(0, errMsg.length(), &quot;Success: Changed permissions of file&quot;).append(targetFilePath.toAbsolutePath()).append(&quot; to &quot;).append(permissions);</span>
<span class="nc" id="L218">            logFine(errMsg.toString());</span>
<span class="nc" id="L219">            return errMsg.toString();</span>
<span class="nc" id="L220">        } catch (Exception e) {</span>
<span class="nc" id="L221">            errMsg.replace(0, errMsg.length(), &quot;Error: Exception setting permissions on file with POSIX: &quot;)</span>
<span class="nc" id="L222">                .append(targetFilePath.toAbsolutePath())</span>
<span class="nc" id="L223">                .append(&quot;, &quot;)</span>
<span class="nc" id="L224">                .append(e.getMessage());</span>
<span class="nc" id="L225">            logSevere(errMsg.toString());</span>
<span class="nc" id="L226">            return errMsg.toString();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>